trigger:
  branches:
    include:
      - main
      - develop

variables:
  imageName:               azdevops-cicd-sample
  imageTag:                $(Build.BuildId)

  azureSubscription:       AzureSubscriptionConnection

  rgName:                  ci-cd-rg
  acrName:                 nithinkatruacr
  appServicePrefix:        cicd-webapp
  servicePlanName:         cicd-asp
  location:                eastus

  tfStateStorageAccount:   tfstateYourSuffix
  tfStateContainer:        tfstate

  sonarOrg:                akhilmano1

stages:
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
- stage: Build
  displayName: "CI: Build, Test, Lint, Sonar"
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: LocalSelfHostedPool1
      demands:
        - agent.os -equals Windows_NT

    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Login to ACR"
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name $(acrName)

    - task: NodeTool@0
      displayName: "Use Node.js 20"
      inputs:
        versionSpec: "20.x"

    - script: npm ci --loglevel error
      displayName: "npm ci"
      workingDirectory: $(Build.SourcesDirectory)

    - script: npm run lint
      displayName: "lint"
      workingDirectory: $(Build.SourcesDirectory)

    - script: npm test
      displayName: "unit tests"
      workingDirectory: $(Build.SourcesDirectory)

    - task: PowerShell@2
      displayName: "Build & push Docker image"
      inputs:
        targetType: inline
        workingDirectory: $(Build.SourcesDirectory)
        script: |
          docker build -t $(acrName).azurecr.io/$(imageName):$(imageTag) .
          docker push $(acrName).azurecr.io/$(imageName):$(imageTag)

    - task: SonarCloudPrepare@3
      displayName: "Sonar ‚Äì prepare"
      inputs:
        SonarCloud: SonarCloud
        organization: $(sonarOrg)
        scannerMode: CLI
        configMode: manual
        cliProjectKey: akhilmano1_azure-devops-cicd-sample-Public
        cliProjectName: CI-CD Sample

    - task: SonarCloudAnalyze@3
      displayName: "Sonar ‚Äì analyze"

    - task: SonarCloudPublish@3
      displayName: "Sonar ‚Äì publish"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Deploy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
- stage: Deploy
  displayName: "CD: Push container to existing App Service"
  dependsOn: Build

  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: $(Build.SourceBranchName)
    pool:
      name: LocalSelfHostedPool1
      demands:
        - agent.os -equals Windows_NT

    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          # 1Ô∏è‚É£ Ensure App Service Plan + Web App exist
          - task: AzureCLI@2
            displayName: "Create plan & webapp if absent"
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: ps
              scriptLocation: inlineScript
              inlineScript: |
                $ErrorActionPreference = 'Continue'
                $rg        = "$(rgName)"
                $planName  = "$(servicePlanName)"
                $appName   = "$(appServicePrefix)-$(Build.SourceBranchName)"
                $location  = "$(location)"

                Write-Host "üîé Checking App Service Plan '$planName'..."
                az appservice plan show -g $rg -n $planName -o none 2>$null
                if ($LASTEXITCODE -ne 0) {
                  Write-Host "‚ûï Creating App Service Plan '$planName'"
                  az appservice plan create `
                    --name $planName `
                    --resource-group $rg `
                    --sku B1 `
                    --is-linux `
                    --location $location

                  Write-Host "‚è≥ Waiting for plan to become available..."
                  do {
                    Start-Sleep -Seconds 5
                    az appservice plan show -g $rg -n $planName -o none 2>$null
                  } while ($LASTEXITCODE -ne 0)
                  Write-Host "‚úÖ Plan provisioned successfully."
                }
                else {
                  Write-Host "‚úÖ Plan already exists."
                }

                Write-Host "üîé Checking Web App '$appName'..."
                az webapp show -g $rg -n $appName -o none 2>$null
                if ($LASTEXITCODE -ne 0) {
                  Write-Host "‚ûï Creating Web App '$appName'"
                  az webapp create `
                    --resource-group $rg `
                    --plan $planName `
                    --name $appName `
                    --deployment-container-image-name "mcr.microsoft.com/oss/nginx/nginx:latest"
                  Write-Host "‚úÖ Web App created."
                }
                else {
                  Write-Host "‚úÖ Web App already exists."
                }

          # 2Ô∏è‚É£ Deploy the container image
          - task: AzureWebAppContainer@1
            displayName: "Deploy container to App Service"
            inputs:
              azureSubscription: $(azureSubscription)
              resourceGroupName: $(rgName)
              appName: "$(appServicePrefix)-$(Build.SourceBranchName)"
              imageName: "$(acrName).azurecr.io/$(imageName):$(imageTag)"
